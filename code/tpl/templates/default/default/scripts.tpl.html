
<script src="assets/js/plugins/canvas-to-blob.min.js" type="text/javascript"></script>

<script src="assets/js/plugins/purify.min.js" type="text/javascript"></script>
<!-- the main fileinput plugin file -->
<script src="assets/js/fileinput.min.js"></script>
<script src="assets/js/locales/ru.js"></script>

<script src="assets/js/plugins/bootstrap-switch.min.js"></script>

<style>
  .file-upload-indicator,
  .file-actions,
  .fileinput-remove,
  .file-caption-main
  {
    display: none;
  }
</style>

<script>
$(document).ready(function() {

  $(".bootstrap-switch").bootstrapSwitch().removeClass('hidden');


  $("#input-dim-2").fileinput({
      uploadUrl: "/ajax/image-upload",
      allowedFileExtensions: ["jpeg", "jpg", "png", "gif"],
      allowedFileTypes: ['image'],
      maxImageWidth: 320,
      maxImageHeight: 240,
      language: "ru",
      browseOnZoneClick: true,
      resizeImage: true,
      resizePreference: 'height',
      showUpload: false,
      fileActionSettings: {
        showUpload: false,
        showRemove: false,
        showZoom: false,
      }

  }).on('fileimageloaded', function(event, previewId) {
    img2preview();
  }).on('filecleared', function(event) {
    imgSrc = "assets/img/placeholder-320x240.png";
    $('#preview-img').attr('src', imgSrc);
  });

  //-----------------------------------------------------------------------

  $('#preview-btn').on('click', function() {

    img2preview();
    feedback2preview();
    name2preview();
    date2preview();

    //$('#feedback-preview').fadeIn(2000);

  });

  //-----------------------------------------------------------------------

  $('#submit-btn').on('click', function() {
    alert('Yo!');
  });

  //-----------------------------------------------------------------------

  $('#feedback').on('input', function() {
    feedback2preview();
  });

  //-----------------------------------------------------------------------

  $('#name').on('keyup', function() {
    name2preview();
  });

  //-----------------------------------------------------------------------

  $('#logout-btn').on('click', function() {
    ajax({
      type: 'POST',
      url: 'ajax/admin-logout',
      success: function(data) {
        if (data.success) {
          location.reload();
        } else {
          showAlert(data.message);
        }
      },
    });
  });

  //-----------------------------------------------------------------------

  $('#login-btn').on('click', function() {
    let pwd = $('#login-pwd').val();

    if (pwd.length<3) {
      showAlert('Пароль должен содержать не менее 3-х символов!');
    } else {
      ajax({
        type: 'POST',
        url: 'ajax/admin-login',
        data: { pwd: pwd },
        success: function(data) {
          if (data.success) {
            location.reload();
          } else {
            showAlert(data.message);
          }
        },
      });
    }
  });

  //-----------------------------------------------------------------------

  $('input.bootstrap-switch').on('switchChange.bootstrapSwitch', function(event, state) {
    let id = $(this).data('id');
    if (state) {
      $('#'+id+'-feedback').removeClass('banned').addClass('approved');
    } else {
      $('#'+id+'-feedback').addClass('banned').removeClass('approved');
    }
    $(this).parent().parent().addClass('fld-changed');
    enableSaveBtn(id);
  });

  //-----------------------------------------------------------------------

  $('.feedback-input').on('input', function() {
    let id = $(this).data('id');
    $(this).addClass('fld-changed');
    enableSaveBtn(id);
  });

  //-----------------------------------------------------------------------

  $('.save-btn').on('click', function() {
    let id = $(this).data('id');
    let feedback = $('#'+id+'-feedback-input').val();
    let approved = $('#'+id+'-switch').prop('checked');
    ajax({
      type: 'POST',
      url: 'ajax/feedback-edit',
      data: { id: id, feedback: feedback, approved: approved },
      success: function(data) {
        $(this).prop('disabled', true);
        if (data.success) {
          //location.reload();
          showNotice('Отзыв сохранен.');
        } else {
          showAlert(data.message);
        }
      },
    });
  });

  //-----------------------------------------------------------------------

  function img2preview() {
    let imgSrc = $('.file-preview-image').attr('src');

    if (!imgSrc) {
      imgSrc = "assets/img/placeholder-320x240.png";
    }
    $('#preview-img').attr('src', imgSrc);

    date2preview()
  }

  function feedback2preview() {
    let feedback = $('#feedback').val().replace(/\n/g, "<br />");
    $('#feedback-preview-body').html(feedback);

    date2preview()
  }

  function name2preview() {
    $('#feedback-preview-title').html($('#name').val());

    date2preview()
  }

  function date2preview() {
    $('#feedback-preview-dt').html('сегодня');
    $('#feedback-preview-dt-container').removeClass('hidden');
  }

  function showAlert(msg) {
    $('#alert-msg').html(msg);
    $('#alert-container').fadeIn(1000);
    setTimeout(function() {
      $('#alert-container').fadeOut(1000);
    }, 5000);
  }


  function showNotice(msg) {
    $('#notice-msg').html(msg);
    $('#notice-container').fadeIn(1000);
    setTimeout(function() {
      $('#notice-container').fadeOut(1000);
    }, 5000);
  }


  function enableSaveBtn(id) {
    let btn = $('#'+id+'-save-btn')
    if ($(btn).prop('disabled')) {
      $(btn).prop('disabled',false).addClass('btn-success').removeClass('btn-default');
    }
  }


  function ajax(data) {
    let prep = {
      type: 'GET',
      error: function(jqXHR, textStatus, error) {
        showAlert(textStatus);
      },
      statusCode: {
        404: function() {
          showAlert( "404: задан неверный адрес для проверки пароля." );
        }
      }
    };

    $.each( data, function( key, value ) {
      prep[key] = value;
    });

    $.ajax(prep);
  }

});
</script>
